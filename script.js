
const posts = [
    {
        id: "1",
        title: "His personality summarized in a video:",
        content: "¬øTe acuerdas cuando te pregunt√© que le pedir√≠as al trotis que te dijera? Lo anot√© y se lo ped√≠ el 2 de agosto para que llegara a tiempo para tu cum KJADKJAKJ 1 grande Patrick Pedraza, realmente no esperaba que hiciera mucho m√°s x lo que le ped√≠, pero me gusto mucho el v√≠deo, ojal√° se pudiera pedir tambi√©n a los japos, yo andar√≠a pidiendo pa mi esposa awaa TE AMO MUCHO",
        media: {
            type: "video",
            url: "video.mp4",
        },
        upvotes: 69,
        user: "Lu",
        subreddit: "r/Scaramouche",
        av_sub: "./icons/yop.png",
        time: "hace 12 d√≠as",
        comments: [{
            user: "Lu",
            avatar: "./icons/yop.png",
            text: "HOLA MI AMOR FELIZ MES DE CUMPLEA√ëOS",
            time: "16h ago",
            upvotes: 143,
            replies: [{
                user: "Lu",
                avatar: "./icons/yop.png",
                text: "QUIERO HACER MUCHAS COSAS PARA TI",
                time: "15h ago",
                upvotes: 143,
                replies: [{
                    user: "Lu",
                    avatar: "./icons/yop.png",
                    text: "ASI QUE DEBER√çAS REVISAR ESTA P√ÅGINA CADA D√çA JEJEJE",
                    time: "14h ago",
                    upvotes: 143
                },
                {
                user: "Lu",
                avatar: "./icons/yop.png",
                text: "DAILY REDDIT AKSJDKAJS TE AMO MUCHO",
                time: "16h ago",
                upvotes: 143
            },
            ]}]
            },
        ],
    },
    {
        id: "2",
        title: "I finished a new project!",
        content: "It is the new building located in the Avidya Forest for the members of the Akademiya, I came to several disagreements with the main organizer, but finally I was able to organize a good environment for the students.",
        media: {
            type: "image",
            url: "edificio.png",
        },
        upvotes: 30,
        user: "Kaveh",
        av_sub: "archi.jpg",
        subreddit: "r/architecture",
        time: "hace 5 d√≠as",
        comments:[{
            user: "kool",
            avatar: "default-avatar.png",
            text: "i passed by there when construction was starting and ngl i thought it would be bigger lol",
            time: "4d ago",
            upvotes: -5,
            replies: [{
                user: "Alhaiham",
                avatar: "./icons/alhaitham.png",
                text: "That's your inferiority complex talking.",
                time: "4d ago",
                upvotes: -1,
                replies: [{
                    user: "kool",
                    avatar: "default-avatar.png",
                    text: "?? wtf",
                    time: "4d ago",
                    upvotes: -1,
                },{
                    user: "Kaveh",
                    avatar: "./icons/kaveh.jpg",
                    text: "ALHAITHAM WHY DO YOU HAVE THAT PFP",
                    time: "4d ago",
                    upvotes: 1,
                    replies: [{
                        user: "Alhaitham",
                        avatar: "./icons/alhaitham.png",
                        text: "I like to look at it when I open this app.",
                        time: "4d ago",
                        upvotes: 0,
                    }]
                }]
            }]
        }]
    },
    {
        id: "3",
        title: "Theres a strange page that i discovered",
        content: "is like a web event or smt? <a href='https://hattalu.github.io/Conteo/' target=\"_blank\"> this one </a> the screen is mostly black and it could just be a random page but idk, ill leave it here in case anyone can discover smt else",
        upvotes: 54,
        user: "notahacker",
        subreddit: "r/WebEvent",
        av_sub: "web.jpg",
        time: "hace 2 d√≠as",
        comments: [{
            user: "ragebaiter",
            avatar: "default-avatar.png",
            text: "and?",
            time: "16h ago",
            upvotes: -68,
        },
        {
            user: "Express-Pudding-1282",
            avatar: "defaultav2.jpg",
            text: "I increased the contrast a bit?",
            image: "contraste.png",
            time: "15h ago",
            upvotes: 128,
            replies: [{
                user: "crystxllizing",
                avatar: "defav3.png",
                text: "looks like one of those void images üò≠",
                time: "15h ago",
                upvotes: 43,
                replies: [{
                    user: "weeb00b5",
                    avatar: "defav6.png",
                    text: "maybe the surprise is a screamer",
                    time: "14h ago",
                    upvotes: 13
                },
                {
                user: "h4cktow4ck",
                avatar: "defav4.png",
                text: "There are hearts so must be a romantic thing",
                time: "6h ago",
                upvotes: 10
            },{
                user: "wklits",
                avatar: "default-avatar.png",
                text: "so the dev copied their idea from that Genshin web event...",
                time: "2h ago",
                upvotes: 5
            }
            ]}]
            },{
                user: "FormalTop1013",
                avatar: "defav5.png",
                text: "do the right click thing -> inspect",
                time: "14h ago",
                upvotes: 18
            }
        ],
    },{
        id: "4",
        title: "AITA for for destroying a building that didn't have any of my sensei's merchandise?",
        content: "When I went to ask, they only told me they can give me <a href='https://i.ibb.co/LD6M7tdC/saitamamerch.jpg' target=\"_blank\"> this keychain </a> for 5 CENTS. Or even FOR FREE? HOW DARE THEY LOWER MY SENSEI'S VALUE?",
        upvotes: 1,
        av_sub: "aita.png",
        user: "SaitamasNumber1Fan",
        subreddit: "r/AmItheAsshole",
        time: "hace 1 d√≠a",
        comments: [{
            user: "justrandomguy",
            avatar: "defav3.png",
            text: "*reads title* wtf<br>*sees who the OP is* oh that guy again<br>yeah i dont think you hear words that arent from your sensei but yeah YTA",
            time: "hace 1 d√≠a",
            upvotes: 30
        },{
            user: "saitama",
            avatar: "./icons/saitama.jpg",
            text: "Genos...",
            time: "hace 1 d√≠a",
            upvotes: 200,
            replies:[{
                user: "SaitamasNumber1Fan",
                avatar: "./icons/genos.jpg",
                text: "I did it when it was night, no one was hurt, sensei!",
                time: "hace 1 d√≠a",
                upvotes: 1
            },{
                user: "CarryFantastic6990",
                avatar: "defav4.png",
                text: "why does it have so many positive votes?",
                time: "hace 1 d√≠a",
                upvotes: -1,
                replies:[{
                    user: "SaitamasNumber1Fan",
                    avatar: "./icons/saitama.jpg",
                    text: "Because my sensei is the best, obviously.",
                    time: "hace 1 d√≠a",
                    upvotes: 1
                },{
                    user: "justrandomguy",
                    avatar: "defav3.png",
                    text: "OP is a very dedicated fan (stalker) of him and created a bunch of accounts to give him upvotes on every message he left.",
                    time: "hace 1 d√≠a",
                    upvotes: 5
                }]
            }]
        }]
    }
];

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

shuffleArray(posts);
displayPosts();

function countComments(comments) {
    if (!comments) return 0;
    return comments.reduce((acc, c) => acc + 1 + countComments(c.replies || []), 0);
}

function createPostElement(post) {
    const postElement = document.createElement("div");
    postElement.className = "post";

    let mediaHTML = "";
    if (post.media) {
        switch (post.media.type) {
            case "image":
                mediaHTML = `<div class="media-container"><img src="${post.media.url}" alt="Imagen"></div>`;
                break;
            case "video":
                if (post.media.url.includes("youtube.com") || post.media.url.includes("youtu.be")) {
                    const videoId = post.media.url.split('v=')[1]?.split('&')[0] || post.media.url.split('/').pop();
                    mediaHTML = `
                        <div class="media-container">
                            <iframe width="100%" height="400" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>
                        </div>`;
                } else {
                    mediaHTML = `
                        <div class="media-container">
                            <video controls>
                                <source src="${post.media.url}" type="video/mp4">
                                Tu navegador no soporta videos.
                            </video>
                        </div>`;
                }
                break;
            case "audio":
                mediaHTML = `
                    <div class="audio-player">
                        <audio controls>
                            <source src="${post.media.url}" type="audio/mpeg">
                            Tu navegador no soporta audio.
                        </audio>
                    </div>`;
                break;
        }
    }

    const textHTML = !post.media
        ? `<p class="post-text">${post.content}</p>`
        : "";

    postElement.innerHTML = `
        <div class="post-header">
            <img src="${post.av_sub || './icons/yop.png'}" alt="Avatar" class="avatar">
            <span class="subreddit">${post.subreddit}</span>
            <span>‚Ä¢</span>
            <span class="time">${post.time}</span>
        </div>
        <div class="post-content">
            <h3 class="post-title">${post.title}</h3>
            ${mediaHTML}
            ${textHTML}
        </div>
        <div class="post-footer">
            <div class="vote-box">
                <button class="vote-btn upvote">
                    <svg viewBox="0 0 24 24" width="22" height="30" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon class="arrow-fill" points="12,6 7,12 11,12 11,18 13,18 13,12 17,12" fill="currentColor" opacity="0"/>
                        <path d="M12 4l-7 8h4v6h6v-6h4z"/>
                    </svg>
                </button>
                <span class="vote-count">${post.upvotes}</span>
                <button class="vote-btn downvote">
                    <svg viewBox="0 0 24 24" width="22" height="30" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(180deg);">
                        <polygon class="arrow-fill" points="12,6 7,12 11,12 11,18 13,18 13,12 17,12" fill="currentColor" opacity="0"/>
                        <path d="M12 4l-7 8h4v6h6v-6h4z"/>
                    </svg>
                </button>
            </div>
            <button class="vote-btn comment-btn">
                <i class="far fa-comment"> </i> ${countComments(post.comments)}
            </button>
        </div>
    `;
    return postElement;
}

function displayRecentPosts() {
    const recentList = document.getElementById("recentPostsList");
    recentList.innerHTML = "";
    posts.slice(0, 5).forEach(post => {
        const li = document.createElement("li");
        li.innerHTML = `
            <div class="recent-post-item">
                <div class="recent-post-meta">
                    <span class="recent-user">${post.user}</span>
                    <span> ‚Ä¢ </span>
                    <span class="recent-time">${post.time}</span>
                </div>
                <div class="recent-title">${post.title}</div>
                <div class="recent-votes">${post.upvotes} upvotes</div>
            </div>
        `;
        recentList.appendChild(li);
    });
}

function displayPosts() {
    const container = document.getElementById("posts");
    if (!container) return;
    container.innerHTML = "";
    posts.forEach(post => {
        const postElement = createPostElement(post);
        container.appendChild(postElement);
    });
    
    document.querySelectorAll(".post").forEach((postDiv, idx) => {
        postDiv.addEventListener("click", function(e) {
            if (
                !e.target.closest('.vote-btn'))
                {
                    localStorage.setItem("selectedPost", JSON.stringify(posts[idx]));
                    localStorage.setItem("selectedComments", JSON.stringify(posts[idx].comments || []));
                    window.location.href = "post.html";
                }
        });
    });

    document.querySelectorAll(".upvote").forEach((btn,idx) => {
        btn.addEventListener("click", function(e) {
            e.stopPropagation();
            const voteCount = this.nextElementSibling;
            const downvoteBtn = this.parentElement.querySelector(".downvote");
            if (!this.classList.contains("upvoted")) {
                this.classList.add("upvoted");
                localStorage.setItem("vote_post_" + posts[idx].id, "upvoted");
                if (downvoteBtn.classList.contains("downvoted")) {
                    downvoteBtn.classList.remove("downvoted");
                    localStorage.setItem("vote_post_" + posts[idx].id, "upvoted");
                    voteCount.textContent = parseInt(voteCount.textContent) + 2;
                } else {
                    voteCount.textContent = parseInt(voteCount.textContent) + 1;
                }
            } else {
                this.classList.remove("upvoted");
                localStorage.removeItem("vote_post_" + posts[idx].id);
                voteCount.textContent = parseInt(voteCount.textContent) - 1;
            }
            localStorage.setItem("vote_post_" + posts[idx].id, "upvoted");
            localStorage.setItem("votes_post_" + posts[idx].id, voteCount.textContent);
        });
    });

    document.querySelectorAll(".downvote").forEach((btn, idx) => {
        btn.addEventListener("click", function(e) {
            e.stopPropagation();
            const voteCount = this.previousElementSibling;
            const upvoteBtn = this.parentElement.querySelector(".upvote");
            if (!this.classList.contains("downvoted")) {
                this.classList.add("downvoted");
                localStorage.setItem("vote_post_" + posts[idx].id, "downvoted");
                if (upvoteBtn.classList.contains("upvoted")) {
                    upvoteBtn.classList.remove("upvoted");
                    localStorage.setItem("vote_post_" + posts[idx].id, "downvoted");
                    voteCount.textContent = parseInt(voteCount.textContent) - 2;
                } else {
                    voteCount.textContent = parseInt(voteCount.textContent) - 1;
                }
            } else {
                this.classList.remove("downvoted");
                localStorage.removeItem("vote_post_" + posts[idx].id);
                voteCount.textContent = parseInt(voteCount.textContent) + 1;
            }
            localStorage.setItem("vote_post_" + posts[idx].id, "upvoted");
            localStorage.setItem("votes_post_" + posts[idx].id, voteCount.textContent);
        });
    });
    displayRecentPosts();
}

const userDropdown = document.getElementById("userDropdown");
if (userDropdown) {
    userDropdown.addEventListener("click", function() {
        const dropdown = document.getElementById("dropdownMenu");
        dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    });
}
window.addEventListener("click", function(e) {
    if (!e.target.closest("#userDropdown")) {
        document.getElementById("dropdownMenu").style.display = "none";
    }
});

window.onload = displayPosts;

document.querySelectorAll('.sidebar-left li').forEach(li => {
    li.addEventListener('click', function() {
        document.querySelectorAll('.sidebar-left li').forEach(el => el.classList.remove('active'));
        this.classList.add('active');
    });
});

document.querySelectorAll(".post").forEach((postDiv, idx) => {
    const upvoteBtn = postDiv.querySelector(".upvote");
    const downvoteBtn = postDiv.querySelector(".downvote");
    const voteState = localStorage.getItem("vote_post_" + posts[idx].id);
    if (voteState === "upvoted") upvoteBtn.classList.add("upvoted");
    if (voteState === "downvoted") downvoteBtn.classList.add("downvoted");
});

localStorage.setItem('posts', JSON.stringify(posts));

const savedPosts = JSON.parse(localStorage.getItem('posts'));
if (savedPosts) {
    posts.length = 0;
    posts.push(...savedPosts);
}

function initSearch() {
    const searchInput = document.querySelector('.search-bar input');
    if (!searchInput) return;
    
    searchInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            performSearch(this.value.trim());
        }
    });
    const searchIcon = document.querySelector('.search-bar .fa-search');
    if (searchIcon) {
        searchIcon.addEventListener('click', function() {
            const searchValue = searchInput.value.trim();
            if (searchValue) {
                performSearch(searchValue);
            }
        });
    }
}

function performSearch(query) {
    if (!query) return;
    const searchTerm = query.toLowerCase();
    const filteredPosts = posts.filter(post => {
        return (
            post.title.toLowerCase().includes(searchTerm) ||
            post.content.toLowerCase().includes(searchTerm) ||
            post.user.toLowerCase().includes(searchTerm) ||
            post.subreddit.toLowerCase().includes(searchTerm)
        );
    });
    displaySearchResults(filteredPosts, query);
}

function displaySearchResults(results, query) {
    const container = document.getElementById('posts');
    if (!container) return;
    
    if (results.length === 0) {
        container.innerHTML = `
            <div class="no-results">
                <h3>No se encontraron resultados para "${query}"</h3>
                <p>Intenta con otras palabras clave o revisa la ortograf√≠a.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    results.forEach(post => {
        const postElement = createPostElement(post);
        container.appendChild(postElement);
    });
    
    attachPostInteractions();
}

function attachPostInteractions() {
    document.querySelectorAll(".post").forEach((postDiv, idx) => {
        const upvoteBtn = postDiv.querySelector(".upvote");
        const downvoteBtn = postDiv.querySelector(".downvote");
        const voteState = localStorage.getItem("vote_post_" + posts[idx].id);
        if (voteState === "upvoted") upvoteBtn.classList.add("upvoted");
        if (voteState === "downvoted") downvoteBtn.classList.add("downvoted");
    });
    
    document.querySelectorAll(".upvote").forEach((btn, idx) => {
        btn.addEventListener("click", function(e) {
            e.stopPropagation();
            const voteCount = this.nextElementSibling;
            const downvoteBtn = this.parentElement.querySelector(".downvote");
            if (!this.classList.contains("upvoted")) {
                this.classList.add("upvoted");
                localStorage.setItem("vote_post_" + posts[idx].id, "upvoted");
                if (downvoteBtn.classList.contains("downvoted")) {
                    downvoteBtn.classList.remove("downvoted");
                    localStorage.setItem("vote_post_" + posts[idx].id, "upvoted");
                    voteCount.textContent = parseInt(voteCount.textContent) + 2;
                } else {
                    voteCount.textContent = parseInt(voteCount.textContent) + 1;
                }
            } else {
                this.classList.remove("upvoted");
                localStorage.removeItem("vote_post_" + posts[idx].id);
                voteCount.textContent = parseInt(voteCount.textContent) - 1;
            }
            localStorage.setItem("vote_post_" + posts[idx].id, "upvoted");
            localStorage.setItem("votes_post_" + posts[idx].id, voteCount.textContent);
        });
    });
    
    document.querySelectorAll(".downvote").forEach((btn, idx) => {
        btn.addEventListener("click", function(e) {
            e.stopPropagation();
            const voteCount = this.nextElementSibling;
            const downvoteBtn = this.parentElement.querySelector(".downvote");
            if (!this.classList.contains("upvoted")) {
                this.classList.add("upvoted");
                localStorage.setItem("vote_post_" + posts[idx].id, "upvoted");
                if (downvoteBtn.classList.contains("downvoted")) {
                    downvoteBtn.classList.remove("downvoted");
                    localStorage.setItem("vote_post_" + posts[idx].id, "upvoted");
                    voteCount.textContent = parseInt(voteCount.textContent) + 2;
                } else {
                    voteCount.textContent = parseInt(voteCount.textContent) + 1;
                }
            } else {
                this.classList.remove("upvoted");
                localStorage.removeItem("vote_post_" + posts[idx].id);
                voteCount.textContent = parseInt(voteCount.textContent) - 1;
            }
            localStorage.setItem("vote_post_" + posts[idx].id, "upvoted");
            localStorage.setItem("votes_post_" + posts[idx].id, voteCount.textContent);
        });
    });
}

document.addEventListener('DOMContentLoaded', function() {
    initSearch();
});